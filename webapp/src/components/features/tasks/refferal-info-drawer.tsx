"use client";
import { useDevice } from "@/components/providers/device-provider";
import showToast from "@/components/ui/custom-toast";
import { claimGift } from "@/lib/actions/lootbox/claim-gift";
import { getActiveLootBoxTasks } from "@/lib/actions/lootbox/get-active-lootbox-tasks";
import { hapticFeedback } from "@/lib/haptic-feedback";
import { cn } from "@/lib/utils";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { openLink, openTelegramLink } from "@telegram-apps/sdk-react";
import { useRouter } from "next/navigation";
import React, { cloneElement, useState, isValidElement } from "react";
import Drawer from "react-modern-drawer";
import { useAuth } from "../auth/hooks/use-auth";
import { shareRefferalLink } from "@/lib/utils/share-refferal-link";

interface RefferalInfoDrawerProps {
  trigger: React.ReactElement;
}

const RefferalInfoDrawer: React.FC<RefferalInfoDrawerProps> = ({ trigger }) => {
  const [isOpen, setIsOpen] = useState(false);
  const { user } = useAuth();
  const { isMobile } = useDevice();

  const toggleDrawer = () => {
    setIsOpen((prevState) => !prevState);
  };
  const renderTrigger = () => {
    if (!isValidElement(trigger)) return null;

    const triggerElement = trigger as React.ReactElement<
      React.ButtonHTMLAttributes<HTMLButtonElement>
    >;

    return cloneElement(triggerElement, {
      onClick: toggleDrawer,
      style: {
        ...(triggerElement.props.style || {}),
      },
    });
  };

  const copyRefferalLink = () => {
    navigator.clipboard.writeText(
      `t.me/${process.env.BOT_USERNAME}?start=ref_${user?.telegramId}`
    );
    showToast?.success("Скопировано в буфер обмена");
    hapticFeedback("success");
  };

  const shareRefLink = () => {
    shareRefferalLink(user?.telegramId || "");
  };

  return (
    <>
      {renderTrigger()}
      <Drawer
        open={isOpen}
        onClose={toggleDrawer}
        direction="bottom"
        className="drawer"
        key={"subscription-drawer"}
        size={isMobile ? 390 : 365}
        style={{
          background: "#96418D",
          borderRadius: "16px 16px 0 0",
          paddingTop: "16px",
          paddingLeft: "16px",
          paddingRight: "16px",
          paddingBottom: isMobile ? "29px" : "8px",
        }}
      >
        <div className="inset-0 relative">
          <h1 className="subscribtion-title font-mono text-left flex items-center">
            Зарабатывай по 10
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="19"
              height="18"
              viewBox="0 0 19 18"
              fill="none"
            >
              <g clipPath="url(#clip0_65_6478)">
                <path
                  fillRule="evenodd"
                  clipRule="evenodd"
                  d="M8.89176 0.937234L6.68697 5.21863C6.55956 5.46606 6.31504 5.63543 6.0344 5.67064L1.65864 6.21972C1.36918 6.25606 1.10509 6.40007 0.921098 6.62193C0.525435 7.09901 0.599538 7.79994 1.08661 8.1875L2.35659 9.55817C2.97077 10.0469 4.18738 10.6134 4.97074 10.504L8.21861 10.0311C8.23625 10.0286 8.30184 10.0163 8.39747 9.99825C8.82356 9.91797 9.84617 9.72529 9.88216 9.79464C9.92799 9.88294 8.94381 10.3046 8.50132 10.4941C8.39472 10.5398 8.31956 10.572 8.29782 10.5828L5.76291 11.6863C4.83995 12.1458 4.49494 13.2602 4.34746 14.264L4.04594 16.3163C4.01418 16.5325 4.05159 16.7531 4.15302 16.9476C4.42413 17.4678 5.0743 17.674 5.60524 17.4085L9.37777 15.5217C9.64483 15.3881 9.96197 15.3921 10.2254 15.5325L13.8666 17.4719C14.086 17.5888 14.3372 17.6353 14.585 17.6048C15.2388 17.5245 15.7023 16.9402 15.6203 16.2998L15.0476 11.8267C15.0233 11.6372 15.0907 11.4474 15.2299 11.3136L18.6762 8.00027C18.8515 7.83182 18.9628 7.60988 18.992 7.37109C19.0627 6.79128 18.6401 6.26511 18.0482 6.19587L13.6879 5.68584C13.3065 5.64123 12.974 5.41094 12.8039 5.07365L10.7216 0.944732C10.6235 0.750015 10.4633 0.59183 10.2653 0.494022C9.76109 0.244884 9.14612 0.443318 8.89176 0.937234Z"
                  fill="#FFECBF"
                />
                <mask
                  id="mask0_65_6478"
                  style={{ maskType: "alpha" }}
                  maskUnits="userSpaceOnUse"
                  x={0}
                  y={0}
                  width={19}
                  height={18}
                >
                  <path
                    d="M9.64834 9.6021C9.64834 9.6021 9.64785 9.60257 9.64648 9.60365C9.6476 9.60265 9.64834 9.6021 9.64834 9.6021ZM8.42379 10.8725L8.43123 10.8693L8.43848 10.8657C8.43848 10.8657 8.43856 10.8656 8.43886 10.8655C8.44046 10.8648 8.44721 10.8616 8.4621 10.8551C8.47812 10.848 8.49922 10.8388 8.5252 10.8276C8.5542 10.8151 8.58774 10.8008 8.62548 10.7846C8.65599 10.7715 8.68924 10.7573 8.7251 10.7419C8.88378 10.6738 9.08598 10.5863 9.28354 10.4967C9.47945 10.4079 9.67752 10.3142 9.8253 10.2337C9.89704 10.1946 9.96935 10.1521 10.0253 10.1098C10.0507 10.0906 10.0915 10.0578 10.1258 10.0129C10.1442 9.98885 10.2587 9.83432 10.1625 9.64891C10.1145 9.55634 10.0382 9.51536 10.0048 9.50014C9.96687 9.48281 9.93244 9.47538 9.91212 9.47177C9.87043 9.46441 9.8294 9.46346 9.79957 9.46367C9.73636 9.46411 9.65952 9.47078 9.5812 9.47969C9.42159 9.49787 9.21695 9.53006 9.01654 9.56429C8.81482 9.59875 8.61205 9.63622 8.45452 9.66574C8.41097 9.6739 8.37291 9.68107 8.3388 9.68749C8.30904 9.6931 8.2823 9.69814 8.25754 9.70279C8.23219 9.70753 8.21169 9.71132 8.19626 9.71412C8.18403 9.71633 8.17775 9.71739 8.17549 9.71777C8.17489 9.71787 8.1745 9.71795 8.1745 9.71795L8.17286 9.71818L4.92681 10.1908L4.92596 10.1909C4.61546 10.234 4.17745 10.1434 3.71608 9.96124C3.27207 9.78595 2.85119 9.54378 2.5715 9.32515L1.31827 7.97255L1.30197 7.95496L1.28321 7.94004C0.933687 7.66193 0.882409 7.16337 1.1642 6.82359C1.29621 6.66442 1.48699 6.5597 1.69779 6.53324L6.07355 5.98416C6.45567 5.93621 6.79169 5.70519 6.96779 5.36323L9.17257 1.08183C9.34631 0.744466 9.77233 0.602988 10.1251 0.777297C10.2625 0.845155 10.3723 0.954245 10.4392 1.08695L12.5214 5.21586C12.7403 5.64983 13.1662 5.94297 13.6509 5.99968L18.0112 6.50971C18.4352 6.5593 18.7268 6.93277 18.678 7.33272C18.6577 7.49848 18.5804 7.65369 18.457 7.77229L15.0106 11.0857C14.8002 11.2879 14.6967 11.5767 14.7338 11.8667L15.3066 16.3398C15.3655 16.8005 15.0321 17.2312 14.5463 17.291C14.3626 17.3136 14.1768 17.2789 14.015 17.1928L10.3738 15.2534C10.02 15.0649 9.59475 15.0595 9.23617 15.2389L5.46365 17.1256C5.08383 17.3156 4.62284 17.1655 4.43311 16.8015C4.3623 16.6656 4.33642 16.5123 4.35848 16.3621L4.65998 14.3098C4.80671 13.3111 5.13496 12.3566 5.89665 11.9726L8.42379 10.8725Z"
                    fill="#FFECBF"
                    stroke="#E6860D"
                    strokeWidth="0.632184"
                  />
                </mask>
                <g mask="url(#mask0_65_6478)">
                  <path
                    fillRule="evenodd"
                    clipRule="evenodd"
                    d="M7.32027 6.4801L9.52506 2.1987C9.77942 1.70479 10.3944 1.50636 10.8986 1.7555C11.0966 1.85331 11.2568 2.0115 11.3549 2.20621L13.4372 6.33511C13.6073 6.67241 13.9398 6.9027 14.3212 6.94732L18.6815 7.45735C19.2734 7.52659 19.696 8.05276 19.6252 8.63256C19.5961 8.87135 19.4849 9.0933 19.3096 9.26174L15.8632 12.5751C15.724 12.7089 15.6566 12.8986 15.6809 13.0881L16.2536 17.5614C16.3356 18.2018 15.8721 18.7859 15.2183 18.8664C14.9705 18.8967 14.7193 18.8502 14.4999 18.7334L10.8587 16.7939C10.5953 16.6536 10.2781 16.6496 10.0111 16.7832L6.23856 18.6701C5.70762 18.9356 5.05743 18.7292 4.78632 18.2092C4.68488 18.0146 4.64748 17.794 4.67924 17.5778L4.98076 15.5255C5.12824 14.5217 5.47325 13.4073 6.39621 12.9478L8.93114 11.8443C9.043 11.7886 9.9123 11.4021 9.85542 11.2926C9.81136 11.2077 8.94817 11.2791 8.85191 11.2926L5.60403 11.7655C4.82069 11.8749 3.60407 11.3083 2.98989 10.8196L1.71991 9.44897C1.23284 9.06142 1.15874 8.36049 1.5544 7.88341C1.73839 7.66154 2.00248 7.51753 2.29194 7.4812L6.6677 6.93211C6.94836 6.8969 7.19285 6.72754 7.32027 6.4801Z"
                    fill="#FFC438"
                  />
                </g>
                <path
                  d="M9.64883 9.60233C9.64883 9.60233 9.64834 9.60281 9.64697 9.6039C9.64809 9.6029 9.64883 9.60233 9.64883 9.60233ZM8.42427 10.8728L8.43172 10.8695L8.43897 10.8659C8.43897 10.8659 8.43905 10.8659 8.43935 10.8657C8.44095 10.865 8.4477 10.8619 8.46258 10.8553C8.47859 10.8482 8.49971 10.8391 8.52569 10.8279C8.55469 10.8154 8.58821 10.801 8.62597 10.7849C8.65647 10.7718 8.68973 10.7575 8.72559 10.7421C8.88425 10.674 9.08647 10.5865 9.28403 10.497C9.47994 10.4082 9.67801 10.3144 9.82579 10.2339C9.89753 10.1948 9.96984 10.1523 10.0258 10.1101C10.0512 10.0909 10.092 10.058 10.1263 10.0131C10.1447 9.9891 10.2592 9.83457 10.163 9.64916C10.115 9.55658 10.0387 9.51562 10.0053 9.5004C9.96736 9.48306 9.93293 9.47561 9.91261 9.47203C9.87092 9.46465 9.82989 9.46371 9.80006 9.46392C9.73685 9.46436 9.66 9.47103 9.58169 9.47994C9.42208 9.49812 9.21744 9.5303 9.01703 9.56453C8.81531 9.59898 8.61254 9.63646 8.45501 9.66598C8.41146 9.67415 8.3734 9.68131 8.33929 9.68774C8.30953 9.69335 8.28279 9.6984 8.25803 9.70303C8.23267 9.70777 8.21218 9.71158 8.19675 9.71436C8.18452 9.71657 8.17824 9.71763 8.17598 9.71802C8.17538 9.71812 8.17499 9.71818 8.17499 9.71818L8.17334 9.71842L4.9273 10.1911L4.92645 10.1912C4.61595 10.2343 4.17794 10.1436 3.71657 9.96149C3.27256 9.78619 2.85168 9.54403 2.57199 9.32541L1.31876 7.9728L1.30246 7.95521L1.2837 7.94028C0.934175 7.66218 0.882897 7.16362 1.16469 6.82384C1.2967 6.66466 1.48748 6.55993 1.69828 6.53349L6.07404 5.98441C6.45616 5.93646 6.79218 5.70543 6.96828 5.36348L9.17306 1.08208C9.3468 0.74471 9.7728 0.603232 10.1256 0.777541C10.2629 0.845401 10.3728 0.954489 10.4397 1.08719L12.5219 5.2161C12.7408 5.65006 13.1667 5.94322 13.6514 5.99991L18.0118 6.50996C18.4357 6.55955 18.7273 6.933 18.6784 7.33295C18.6584 7.49871 18.5809 7.65393 18.4575 7.77254L15.0111 11.0859C14.8007 11.2882 14.6972 11.577 14.7343 11.8669L15.3071 16.3401C15.366 16.8008 15.0326 17.2315 14.5467 17.2912C14.3631 17.3138 14.1772 17.2792 14.0155 17.1931L10.3743 15.2536C10.0204 15.0651 9.59524 15.0598 9.23666 15.2391L5.46414 17.1259C5.08432 17.3159 4.62333 17.1657 4.4336 16.8017C4.36279 16.6658 4.33691 16.5125 4.35897 16.3624L4.66047 14.3101C4.8072 13.3114 5.13545 12.3569 5.89714 11.9728L8.42427 10.8728Z"
                  stroke="#E6860D"
                  strokeWidth="0.632184"
                />
              </g>
              <defs>
                <clipPath id="clip0_65_6478">
                  <rect
                    width="18.3333"
                    height="17.227"
                    fill="white"
                    transform="translate(0.666748 0.386475)"
                  />
                </clipPath>
              </defs>
            </svg>
          </h1>
          <p className="subscription-p mt-1 text-left">За каждого друга</p>
          <p className="subscription-p mt-5 text-left">
            Как пригласить больше друзей?{" "}
          </p>
          <button className="absolute top-0 right-0" onClick={toggleDrawer}>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 20 20"
              fill="none"
            >
              <g clipPath="url(#clip0_58_361)">
                <path
                  d="M16.1481 3.38268C15.7884 3.02298 15.2052 3.02298 14.8455 3.38268L3.3827 14.8455C3.023 15.2052 3.023 15.7884 3.3827 16.1481C3.7424 16.5078 4.32559 16.5078 4.68529 16.1481L16.1481 4.68528C16.5078 4.32557 16.5078 3.74238 16.1481 3.38268Z"
                  fill="white"
                />
                <path
                  d="M4.68529 3.38268C4.32559 3.02298 3.7424 3.02298 3.3827 3.38268C3.023 3.74238 3.023 4.32557 3.3827 4.68528L14.8455 16.1481C15.2052 16.5078 15.7884 16.5078 16.1481 16.1481C16.5078 15.7884 16.5078 15.2052 16.1481 14.8455L4.68529 3.38268Z"
                  fill="white"
                />
              </g>
              <defs>
                <clipPath id="clip0_58_361">
                  <rect width="20" height="20" fill="white" />
                </clipPath>
              </defs>
            </svg>
          </button>
        </div>
        <div className="refferal-drawer-section mt-2">
          <p className="refferal-drawer-section-p">
            <span className="refferal-drawer-section-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="12"
                height="12"
                viewBox="0 0 12 12"
                fill="none"
              >
                <g clipPath="url(#clip0_67_59)">
                  <path
                    d="M0.500017 5.99355C0.495339 7.16889 1.44436 8.12549 2.61973 8.13017C3.16103 8.13231 3.68282 7.92812 4.07887 7.55912L7.2503 8.99104C7.22826 9.10962 7.21618 9.2298 7.21414 9.3504C7.21041 10.5338 8.16673 11.4962 9.35018 11.5C10.5336 11.5038 11.496 10.5474 11.4998 9.36396C11.5035 8.18051 10.5472 7.21811 9.36374 7.21436C8.65668 7.21213 7.99404 7.55882 7.59273 8.14096L4.61309 6.79556C4.82473 6.28452 4.82554 5.7105 4.61539 5.19885L7.5909 3.84659C8.26093 4.81565 9.58967 5.05804 10.5587 4.38802C11.5278 3.71799 11.7702 2.38927 11.1001 1.4202C10.4301 0.451137 9.10138 0.208747 8.13231 0.878774C7.5552 1.27781 7.2112 1.93509 7.2123 2.63672C7.21423 2.75749 7.22648 2.87785 7.24893 2.99653L4.08574 4.43392C3.22873 3.62918 1.88161 3.67156 1.07687 4.52857C0.704426 4.92524 0.498 5.44944 0.500017 5.99355Z"
                    fill="white"
                  />
                </g>
                <defs>
                  <clipPath id="clip0_67_59">
                    <rect
                      width="11"
                      height="11"
                      fill="white"
                      transform="translate(0.5 0.5)"
                    />
                  </clipPath>
                </defs>
              </svg>
            </span>
            <span className="font-mono refferal-drawer-section-text">
              Поделитесь ботом со своими друзьями.
            </span>
          </p>
          <p className="refferal-drawer-section-p">
            <span className="refferal-drawer-section-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="12"
                height="12"
                viewBox="0 0 12 12"
                fill="none"
              >
                <g clipPath="url(#clip0_67_75)">
                  <path
                    d="M6.38323 0.513286C4.79098 0.405578 3.23219 0.98812 2.1079 2.11379C0.983604 3.23945 0.403354 4.79824 0.513813 6.39141C0.715479 9.30366 3.28765 11.5 6.4969 11.5H9.20885C10.4725 11.5 11.5005 10.472 11.5005 9.20833V6.15583C11.5001 3.18674 9.2524 0.708078 6.38323 0.513286ZM3.7084 6.6875C3.3289 6.6875 3.0209 6.3795 3.0209 6C3.0209 5.62049 3.3289 5.3125 3.7084 5.3125C4.0879 5.3125 4.3959 5.62049 4.3959 6C4.3959 6.3795 4.0879 6.6875 3.7084 6.6875ZM6.00006 6.6875C5.62056 6.6875 5.31256 6.3795 5.31256 6C5.31256 5.62049 5.62056 5.3125 6.00006 5.3125C6.37956 5.3125 6.68756 5.62049 6.68756 6C6.68756 6.3795 6.37956 6.6875 6.00006 6.6875ZM8.29173 6.6875C7.91223 6.6875 7.60423 6.3795 7.60423 6C7.60423 5.62049 7.91223 5.3125 8.29173 5.3125C8.67123 5.3125 8.97923 5.62049 8.97923 6C8.97923 6.3795 8.67123 6.6875 8.29173 6.6875Z"
                    fill="white"
                  />
                </g>
                <defs>
                  <clipPath id="clip0_67_75">
                    <rect
                      width="11"
                      height="11"
                      fill="white"
                      transform="translate(0.5 0.5)"
                    />
                  </clipPath>
                </defs>
              </svg>
            </span>
            <span className="font-mono refferal-drawer-section-text">
              Распространяйте ссылку по комментариям каналов где это разрешено.
            </span>
          </p>
          <p className="refferal-drawer-section-p">
            <span className="refferal-drawer-section-icon">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="12"
                height="12"
                viewBox="0 0 12 12"
                fill="none"
              >
                <path
                  fillRule="evenodd"
                  clipRule="evenodd"
                  d="M6.91658 1.41663C7.42286 1.41663 7.83325 1.82703 7.83325 2.33329C7.83325 2.99665 8.30533 3.55328 8.93252 3.68075C9.42862 3.78159 9.74904 4.26551 9.64821 4.76163C9.54737 5.25773 9.06346 5.5782 8.56732 5.47737C8.31019 5.42507 8.06411 5.34207 7.83325 5.23234V7.83329C7.83325 9.35207 6.60203 10.5833 5.08325 10.5833C3.56447 10.5833 2.33325 9.35207 2.33325 7.83329C2.33325 6.55065 3.21053 5.47521 4.39643 5.16996C4.88671 5.04379 5.38649 5.33895 5.51266 5.82923C5.63884 6.31951 5.34368 6.81928 4.85341 6.94545C4.45784 7.04725 4.16659 7.40741 4.16659 7.83329C4.16659 8.33957 4.57699 8.74996 5.08325 8.74996C5.58953 8.74996 5.99992 8.33957 5.99992 7.83329V2.33329C5.99992 1.82703 6.41031 1.41663 6.91658 1.41663Z"
                  fill="white"
                />
              </svg>
            </span>
            <span className="font-mono refferal-drawer-section-text">
              Делитесь ссылкой в комментариях TikTok
            </span>
          </p>
        </div>
        <p className="subscription-p mt-5 text-left">
          Как пригласить больше друзей?{" "}
        </p>
        <button
          className="refferal-drawer-section mt-2 font-mono refferal-drawer-section-text relative cursor-pointer w-full refferal-drawer-button"
          onClick={copyRefferalLink}
        >
          t.me/{process.env.BOT_USERNAME}
          ?start=ref_{user?.telegramId || "oopss"}
          <span className="absolute right-2.5">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
            >
              <path
                d="M7.99991 14C5.42378 13.9971 3.33619 11.9095 3.33325 9.33338V3.33338C3.33325 3.20003 3.34191 3.06672 3.35325 2.93872C2.12925 3.46453 1.33525 4.66788 1.33325 6.00003V12.6667C1.33544 14.5067 2.82653 15.9978 4.66656 16H8.66656C9.99872 15.998 11.2021 15.204 11.7279 13.98C11.5946 13.9914 11.4666 14 11.3333 14H7.99991Z"
                fill="white"
              />
              <path
                d="M14.1033 2.18129L12.5807 0.608639C12.413 0.438857 12.2164 0.300451 12 0.199951V2.66661H14.44C14.3525 2.48901 14.2391 2.32542 14.1033 2.18129Z"
                fill="white"
              />
              <path
                d="M11.3333 2.66663C11.3333 3.03482 11.6317 3.33329 11.9999 3.33329H14.6439C14.5948 2.90041 14.4048 2.49563 14.1033 2.18129L12.5806 0.608631C12.2475 0.271006 11.8056 0.0622246 11.3333 0.0192871V2.66663Z"
                fill="white"
              />
              <path
                d="M10.0001 2.66666V0H8.00009C6.16006 0.00221875 4.66897 1.49331 4.66675 3.33334V9.33334C4.66897 11.1734 6.16006 12.6645 8.00009 12.6667H11.3334C13.1735 12.6645 14.6646 11.1734 14.6668 9.33334V4.66666H12.0001C10.8955 4.66666 10.0001 3.77125 10.0001 2.66666Z"
                fill="white"
              />
            </svg>
          </span>
        </button>

        <div className="flex items-center gap-2.5 mt-2.5">
          <button className="subscription-secondary font-mono refferal-drawer-button">
            Закрыть
          </button>
          <button
            className="subscription-primary font-mono refferal-drawer-button"
            // onClick={handleClaimGift}
            onClick={shareRefLink}
          >
            Поделиться
          </button>
        </div>
      </Drawer>
    </>
  );
};

export default RefferalInfoDrawer;
